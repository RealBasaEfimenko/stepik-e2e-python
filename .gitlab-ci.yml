image: python:3.11-slim

stages:
  - test
  - report

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PLAYWRIGHT_BROWSERS_PATH: "/ms-playwright"

cache:
  paths:
    - .cache/pip
    - /ms-playwright

before_script:
  - python -V
  - pip install --upgrade pip
  - pip install -r requirements.txt
  - playwright install --with-deps chromium

# ---------- ТЕСТЫ ----------
tests:
  stage: test
  script:
    - pytest tests --alluredir=allure-results -v
  artifacts:
    when: always
    paths:
      - allure-results
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ---------- ALLURE ОТЧЁТ ----------
allure-report:
  stage: report
  image: frankescobar/allure-docker-service
  needs:
    - job: tests
      artifacts: true
  script:
    - allure generate allure-results -o public --clean
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ---------- GITLAB PAGES ----------
pages:
  stage: report
  needs:
    - job: allure-report
      artifacts: true
  script:
    - echo "Publishing Allure report to GitLab Pages"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
